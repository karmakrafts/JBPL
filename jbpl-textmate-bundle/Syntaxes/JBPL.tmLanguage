<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
    <dict>
        <key>fileTypes</key>
        <array>
            <string>jbpl</string>
        </array>
        <key>name</key>
        <string>Java Bytecode Patch Language</string>
        <key>patterns</key>
        <array>
            <dict>
                <key>include</key>
                <string>#body</string>
            </dict>
        </array>
        <key>repository</key>
        <dict>
            <key>body</key>
            <dict>
                <key>patterns</key>
                <array>
                    <!-- whitespace and newlines -->
                    <dict>
                        <key>match</key>
                        <string>[^\S\n]+</string>
                        <key>name</key>
                        <string>text.whitespace.jbpl</string>
                    </dict>

                    <!-- line continuation -->
                    <dict>
                        <key>match</key>
                        <string>\\\n</string>
                        <key>name</key>
                        <string>constant.character.escape.line-continuation.jbpl</string>
                    </dict>

                    <!-- comments -->
                    <dict>
                        <key>include</key>
                        <string>#comments</string>
                    </dict>

                    <!-- preprocessor ^class -->
                    <dict>
                        <key>begin</key>
                        <string>\^class\b\s+</string>
                        <key>beginCaptures</key>
                        <dict>
                            <key>0</key>
                            <dict>
                                <key>name</key>
                                <string>keyword.other.preprocessor.class.jbpl</string>
                            </dict>
                        </dict>
                        <key>end</key>
                        <string>(?&lt;=\w)</string>
                        <key>patterns</key>
                        <array>
                            <dict>
                                <key>match</key>
                                <string>[A-Za-z_][A-Za-z0-9_$]*</string>
                                <key>name</key>
                                <string>entity.name.type.class.jbpl</string>
                            </dict>
                        </array>
                    </dict>

                    <!-- fun/macro/field/define forms where an identifier follows -->
                    <dict>
                        <key>begin</key>
                        <string>\b(fun)\b\s+(?![)=\s])</string>
                        <key>beginCaptures</key>
                        <dict>
                            <key>1</key>
                            <dict>
                                <key>name</key>
                                <string>storage.type.function.jbpl</string>
                            </dict>
                        </dict>
                        <key>end</key>
                        <string>(?=\s|\.|\(|\{|\$|:|\n)</string>
                        <key>patterns</key>
                        <array>
                            <dict>
                                <key>include</key>
                                <string>#class-type</string>
                            </dict>
                            <dict>
                                <key>match</key>
                                <string>(?:\.)\s*([A-Za-z_][A-Za-z0-9_$]*|&lt;[A-Za-z_][A-Za-z0-9_$]*&gt;)</string>
                                <key>captures</key>
                                <dict>
                                    <key>1</key>
                                    <dict>
                                        <key>name</key>
                                        <string>entity.name.function.jbpl</string>
                                    </dict>
                                </dict>
                            </dict>
                            <dict>
                                <key>include</key>
                                <string>#interpolation-entry-pop</string>
                            </dict>
                            <dict>
                                <key>include</key>
                                <string>#punctuation</string>
                            </dict>
                        </array>
                    </dict>

                    <dict>
                        <key>begin</key>
                        <string>\b(macro)\b\s+</string>
                        <key>beginCaptures</key>
                        <dict>
                            <key>1</key>
                            <dict>
                                <key>name</key>
                                <string>storage.type.macro.jbpl</string>
                            </dict>
                        </dict>
                        <key>end</key>
                        <string>(?=\s|\.|\{|\$|:|\n)</string>
                        <key>patterns</key>
                        <array>
                            <dict>
                                <key>match</key>
                                <string>[A-Za-z_][A-Za-z0-9_$]*</string>
                                <key>name</key>
                                <string>entity.name.function.macro.jbpl</string>
                            </dict>
                            <dict>
                                <key>include</key>
                                <string>#interpolation-entry-pop</string>
                            </dict>
                            <dict>
                                <key>include</key>
                                <string>#punctuation</string>
                            </dict>
                        </array>
                    </dict>

                    <dict>
                        <key>begin</key>
                        <string>\b(field)\b\s+</string>
                        <key>beginCaptures</key>
                        <dict>
                            <key>1</key>
                            <dict>
                                <key>name</key>
                                <string>storage.type.field.jbpl</string>
                            </dict>
                        </dict>
                        <key>end</key>
                        <string>(?=\s|\{|\$|:|\n)</string>
                        <key>patterns</key>
                        <array>
                            <dict>
                                <key>include</key>
                                <string>#class-type</string>
                            </dict>
                            <dict>
                                <key>match</key>
                                <string>[A-Za-z_][A-Za-z0-9_$]*</string>
                                <key>name</key>
                                <string>variable.other.member.jbpl</string>
                            </dict>
                            <dict>
                                <key>include</key>
                                <string>#interpolation-entry-pop</string>
                            </dict>
                            <dict>
                                <key>include</key>
                                <string>#punctuation</string>
                            </dict>
                        </array>
                    </dict>

                    <dict>
                        <key>begin</key>
                        <string>\b(define)\b\s+</string>
                        <key>beginCaptures</key>
                        <dict>
                            <key>1</key>
                            <dict>
                                <key>name</key>
                                <string>keyword.other.define.jbpl</string>
                            </dict>
                        </dict>
                        <key>end</key>
                        <string>(?=\s|\{|\$|:|\n)</string>
                        <key>patterns</key>
                        <array>
                            <dict>
                                <key>match</key>
                                <string>[A-Za-z_][A-Za-z0-9_$]*</string>
                                <key>name</key>
                                <string>variable.other.definition.jbpl</string>
                            </dict>
                            <dict>
                                <key>include</key>
                                <string>#interpolation-entry-pop</string>
                            </dict>
                            <dict>
                                <key>include</key>
                                <string>#punctuation</string>
                            </dict>
                        </array>
                    </dict>

                    <!-- selection after 'by' -->
                    <dict>
                        <key>begin</key>
                        <string>\b(by)\b\s+</string>
                        <key>beginCaptures</key>
                        <dict>
                            <key>1</key>
                            <dict>
                                <key>name</key>
                                <string>keyword.other.by.jbpl</string>
                            </dict>
                        </dict>
                        <key>end</key>
                        <string>(?=\s|\)|\]|\n)</string>
                        <key>patterns</key>
                        <array>
                            <dict>
                                <key>match</key>
                                <string>[A-Za-z_][A-Za-z0-9_$]*</string>
                                <key>name</key>
                                <string>entity.name.function.selection.jbpl</string>
                            </dict>
                        </array>
                    </dict>

                    <!-- names inside fun. and field. scope references -->
                    <dict>
                        <key>match</key>
                        <string>\b(fun)\b\s*(\.)\s*([A-Za-z_][A-Za-z0-9_$]*)</string>
                        <key>captures</key>
                        <dict>
                            <key>1</key>
                            <dict>
                                <key>name</key>
                                <string>storage.type.function.jbpl</string>
                            </dict>
                            <key>2</key>
                            <dict>
                                <key>name</key>
                                <string>punctuation.separator.dot.jbpl</string>
                            </dict>
                            <key>3</key>
                            <dict>
                                <key>name</key>
                                <string>variable.other.jbpl</string>
                            </dict>
                        </dict>
                    </dict>
                    <dict>
                        <key>match</key>
                        <string>\b(field)\b\s*(\.)\s*([A-Za-z_][A-Za-z0-9_$]*)</string>
                        <key>captures</key>
                        <dict>
                            <key>1</key>
                            <dict>
                                <key>name</key>
                                <string>storage.type.field.jbpl</string>
                            </dict>
                            <key>2</key>
                            <dict>
                                <key>name</key>
                                <string>punctuation.separator.dot.jbpl</string>
                            </dict>
                            <key>3</key>
                            <dict>
                                <key>name</key>
                                <string>variable.other.jbpl</string>
                            </dict>
                        </dict>
                    </dict>

                    <!-- names in signatures: .name: (field) and .name( (function) -->
                    <dict>
                        <key>match</key>
                        <string>(\.)\s*([A-Za-z_][A-Za-z0-9_$]*)\s*(?=:)</string>
                        <key>captures</key>
                        <dict>
                            <key>1</key>
                            <dict>
                                <key>name</key>
                                <string>punctuation.separator.dot.jbpl</string>
                            </dict>
                            <key>2</key>
                            <dict>
                                <key>name</key>
                                <string>variable.other.member.jbpl</string>
                            </dict>
                        </dict>
                    </dict>
                    <dict>
                        <key>match</key>
                        <string>(\.)\s*([A-Za-z_][A-Za-z0-9_$]*)\s*(?=\()</string>
                        <key>captures</key>
                        <dict>
                            <key>1</key>
                            <dict>
                                <key>name</key>
                                <string>punctuation.separator.dot.jbpl</string>
                            </dict>
                            <key>2</key>
                            <dict>
                                <key>name</key>
                                <string>entity.name.function.jbpl</string>
                            </dict>
                        </dict>
                    </dict>

                    <!-- special keywords like ^return ^class (when not in prepro begin) -->
                    <dict>
                        <key>match</key>
                        <string>\^(?:return|class)\b</string>
                        <key>name</key>
                        <string>keyword.control.special.jbpl</string>
                    </dict>

                    <!-- keywords -->
                    <dict>
                        <key>match</key>
                        <string>\b(?:typeof|opcodeof|sizeof|yeet|inject|field|fun|class|macro|public|protected|private|static|sync|final|transient|volatile|assert|version|define|include|if|else|when|for|break|continue|default|this|is|as|in|by)\b</string>
                        <key>name</key>
                        <string>keyword.other.jbpl</string>
                    </dict>
                    <!-- preprocessor type keywords -->
                    <dict>
                        <key>match</key>
                        <string>\b(?:type|opcode|instruction|signature)\b</string>
                        <key>name</key>
                        <string>keyword.other.preprocessor.jbpl</string>
                    </dict>
                    <!-- type keywords -->
                    <dict>
                        <key>match</key>
                        <string>\b(?:void|char|bool|string|i8|i16|i32|i64|f32|f64)\b</string>
                        <key>name</key>
                        <string>storage.type.jbpl</string>
                    </dict>
                    <!-- constants -->
                    <dict>
                        <key>match</key>
                        <string>\b(?:true|false)\b</string>
                        <key>name</key>
                        <string>constant.language.boolean.jbpl</string>
                    </dict>

                    <!-- JVM-like instructions as operators/words -->
                    <dict>
                        <key>match</key>
                        <string>\b(?:ldc|[bs]ipush|iconst_(?:m1|[0-5])|lconst_[01]|fconst_[0-2]|dconst_[01]|aconst_null|[ilfda](?:load|store)|dup(?:2)?(?:_x[12])?|pop(?:2)?|(?:get(?:field|static))|(?:put(?:field|static))|goto|jsr|ret|i2[bcdfls]|f2[dil]|d2[fil]|l2[dfi]|[il](?:ushr|shl|shr|and|xor|or)|[ilfd](?:add|sub|mul|div|rem|neg)|multianewarray|arraylength|anewarray|[ilfdacsz]newarray|[ilfda]aload|[ilfda]astore|(?:monitor(?:enter|exit))|athrow|iinc|nop|(?:lookup|table)switch|[ilfda]?return|checkcast|instanceof|new|if_acmp(?:eq|ne)|if(?:_icmp)?(?:eq|ne|lt|ge|gt|le)|invoke(?:interface|virtual|static|special|dynamic))\b</string>
                        <key>name</key>
                        <string>keyword.operator.word.jbpl</string>
                    </dict>

                    <!-- literals (numbers, strings, chars) -->
                    <dict>
                        <key>include</key>
                        <string>#literals</string>
                    </dict>

                    <!-- generic interpolation in code: ${ ... } -->
                    <dict>
                        <key>begin</key>
                        <string>\$\{</string>
                        <key>beginCaptures</key>
                        <dict>
                            <key>0</key>
                            <dict>
                                <key>name</key>
                                <string>keyword.other.interpolation.begin.jbpl</string>
                            </dict>
                        </dict>
                        <key>end</key>
                        <string>}</string>
                        <key>endCaptures</key>
                        <dict>
                            <key>0</key>
                            <dict>
                                <key>name</key>
                                <string>keyword.other.interpolation.end.jbpl</string>
                            </dict>
                        </dict>
                        <key>name</key>
                        <string>meta.interpolation.expr.jbpl</string>
                        <key>patterns</key>
                        <array>
                            <dict>
                                <key>include</key>
                                <string>#body</string>
                            </dict>
                        </array>
                    </dict>

                    <!-- macro call like ...}.name(  -->
                    <dict>
                        <key>match</key>
                        <string>(?&lt;=[&gt;}]\.)[A-Za-z_][A-Za-z0-9_$]*(?=\()</string>
                        <key>name</key>
                        <string>entity.name.function.macro.call.jbpl</string>
                    </dict>

                    <!-- class type names like &lt;java/lang/String&gt; -->
                    <dict>
                        <key>include</key>
                        <string>#class-type</string>
                    </dict>

                    <!-- brackets and punctuation, and identifiers -->
                    <dict>
                        <key>include</key>
                        <string>#brackets</string>
                    </dict>
                    <dict>
                        <key>include</key>
                        <string>#punctuation</string>
                    </dict>
                    <dict>
                        <key>match</key>
                        <string>[A-Za-z_][A-Za-z0-9_$]*</string>
                        <key>name</key>
                        <string>variable.other.jbpl</string>
                    </dict>
                </array>
            </dict>

            <!-- comments repository -->
            <key>comments</key>
            <dict>
                <key>patterns</key>
                <array>
                    <dict>
                        <key>begin</key>
                        <string>/\*</string>
                        <key>end</key>
                        <string>\*/</string>
                        <key>name</key>
                        <string>comment.block.jbpl</string>
                    </dict>
                    <dict>
                        <key>match</key>
                        <string>//.*$</string>
                        <key>name</key>
                        <string>comment.line.double-slash.jbpl</string>
                    </dict>
                </array>
            </dict>

            <!-- class type like &lt;pkg/Clazz&gt; or &lt;A/B/C&gt; -->
            <key>class-type</key>
            <dict>
                <key>match</key>
                <string>&lt;[A-Za-z_][A-Za-z0-9_$]*(?:/[A-Za-z_][A-Za-z0-9_$]*)&gt;</string>
                <key>name</key>
                <string>entity.name.type.class.internal-name.jbpl</string>
            </dict>

            <!-- literals repository (strings, chars, numbers) -->
            <key>literals</key>
            <dict>
                <key>patterns</key>
                <array>
                    <!-- double-quoted string with interpolation -->
                    <dict>
                        <key>begin</key>
                        <string>"</string>
                        <key>beginCaptures</key>
                        <dict>
                            <key>0</key>
                            <dict>
                                <key>name</key>
                                <string>string.quoted.double.jbpl</string>
                            </dict>
                        </dict>
                        <key>end</key>
                        <string>"</string>
                        <key>endCaptures</key>
                        <dict>
                            <key>0</key>
                            <dict>
                                <key>name</key>
                                <string>string.quoted.double.jbpl</string>
                            </dict>
                        </dict>
                        <key>patterns</key>
                        <array>
                            <dict>
                                <key>include</key>
                                <string>#string-interpolation</string>
                            </dict>
                            <dict>
                                <key>match</key>
                                <string>[^"$\{\}]++</string>
                                <key>name</key>
                                <string>string.quoted.double.jbpl</string>
                            </dict>
                        </array>
                    </dict>

                    <!-- character literal -->
                    <dict>
                        <key>match</key>
                        <string>'\\.'|'[^\\]'</string>
                        <key>name</key>
                        <string>constant.character.jbpl</string>
                    </dict>

                    <!-- numbers -->
                    <dict>
                        <key>match</key>
                        <string>0[bB][01][01_]*?(?:i8|i16|i32|i64)?\b</string>
                        <key>name</key>
                        <string>constant.numeric.binary.jbpl</string>
                    </dict>
                    <dict>
                        <key>match</key>
                        <string>0[xX][0-9A-Fa-f][0-9A-Fa-f_]*?(?:i8|i16|i32|i64)?\b</string>
                        <key>name</key>
                        <string>constant.numeric.hex.jbpl</string>
                    </dict>
                    <dict>
                        <key>match</key>
                        <string>0[oO][0-7][0-7_]*?(?:i8|i16|i32|i64)?\b</string>
                        <key>name</key>
                        <string>constant.numeric.octal.jbpl</string>
                    </dict>
                    <dict>
                        <key>match</key>
                        <string>[0-9][0-9_]*(?:\.[0-9][0-9_]*)?(?:[eE][0-9][0-9_]*)?(?:f32|f64)\b</string>
                        <key>name</key>
                        <string>constant.numeric.float.jbpl</string>
                    </dict>
                    <dict>
                        <key>match</key>
                        <string>[0-9][0-9_]*(?:i8|i16|i32|i64)?\b</string>
                        <key>name</key>
                        <string>constant.numeric.decimal.jbpl</string>
                    </dict>
                </array>
            </dict>

            <!-- string interpolation ${ ... }  -->
            <key>string-interpolation</key>
            <dict>
                <key>patterns</key>
                <array>
                    <dict>
                        <key>begin</key>
                        <string>\$\{</string>
                        <key>beginCaptures</key>
                        <dict>
                            <key>0</key>
                            <dict>
                                <key>name</key>
                                <string>keyword.jbpl</string>
                            </dict>
                        </dict>
                        <key>end</key>
                        <string>}</string>
                        <key>endCaptures</key>
                        <dict>
                            <key>0</key>
                            <dict>
                                <key>name</key>
                                <string>keyword.jbpl</string>
                            </dict>
                        </dict>
                        <key>patterns</key>
                        <array>
                            <dict>
                                <key>include</key>
                                <string>#body</string>
                            </dict>
                        </array>
                    </dict>
                </array>
            </dict>

            <!-- interpolation entry that pops outer construct (used in define/field/fun heads) -->
            <key>interpolation-entry-pop</key>
            <dict>
                <key>patterns</key>
                <array>
                    <dict>
                        <key>begin</key>
                        <string>\$\{</string>
                        <key>end</key>
                        <string>}</string>
                        <key>name</key>
                        <string>meta.interpolation.jbpl</string>
                        <key>patterns</key>
                        <array>
                            <dict>
                                <key>include</key>
                                <string>#body</string>
                            </dict>
                        </array>
                    </dict>
                </array>
            </dict>

            <!-- brackets and punctuation -->
            <key>brackets</key>
            <dict>
                <key>patterns</key>
                <array>
                    <dict>
                        <key>match</key>
                        <string>[()]</string>
                        <key>name</key>
                        <string>punctuation.section.parens.jbpl</string>
                    </dict>
                    <dict>
                        <key>match</key>
                        <string>[\[\]]</string>
                        <key>name</key>
                        <string>punctuation.section.brackets.jbpl</string>
                    </dict>
                    <dict>
                        <key>match</key>
                        <string>[{}]</string>
                        <key>name</key>
                        <string>punctuation.section.braces.jbpl</string>
                    </dict>
                </array>
            </dict>
            
            <key>punctuation</key>
            <dict>
                <key>match</key>
                <string>[$~!%^&amp;*()+=|\[\]:,.&lt;&gt;\/?-]</string>
                <key>name</key>
                <string>punctuation.other.jbpl</string>
            </dict>
        </dict>
    </dict>
</plist>